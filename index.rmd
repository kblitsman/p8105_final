---
title: "Investigating the Effect of Marijuana Legalization Use"
---

### Project Purpose
The premise of this project is to look at how the legalization of marijuana has affected the use of other substances, such as illicit drugs, alcohol and cigarettes. The dataset being utilized comes from The National Survey on Drug Use and Health (NSDUH), which measures the prevalence and correlates of drug use in the United States both quarterly and annually. Furthermore, to investigate potential differences in states that have legalized marijuana from the period prior to legalization and after, through time-series graphs. Another important comparison to make would be between states that have legalized marijuana and those that haven't to better understand any potential changes in substance use due to legalization.

### Data
To examine marijuana and other substance use, we used the [National Survey on Drug Use and Health (NSDUH)](https://nsduhweb.rti.org/respweb/homepage.cfm). The NSDUH contains data on various tobacco, alcohol, and other substance use while also containing some basic demographic information such as age and state of residence. The [dataset](https://datafiles.samhsa.gov/study/national-survey-drug-use-and-health-nsduh-2015-nid16893) that was utilized contained data from 1999 to 2015, which unfortunately does not provide a large amount of data for examining Colorado's 2014 legalization of marijuana.

### Analysis
We initially decided to create an interactive shiny graph to allow for examination of state counts of substance use over the past years. By creating a time-series graph for a selected state, a user will be able to visualize the overall trend for a specific substance across the ten year time period. Users can view this across various age groups or for all age groups combined to view potential differences by age and by state. This provided us with the opportunity to assess the estimated count of substance users in states with various policies regarding marijuana and other substances, which can help to inform us as to the true effects of marijuana legalization.

We then decided that we would like to implement an easy way to compare the amount of substance users within states to other states. In order to do this, we created a proportion measure for users to total population to ensure an appropriate comparison. Then, we created a clustered bar chart displaying the relationship between year and proportion of substance user for two selected states. This allows quick between state comparisons, which can help us to understand how marijuana legalization has effected other substance use.

### Timeline of when recreational marijuana was legalized by vote
```{r timeline, echo=FALSE}
library(timevis)

# Election date that it was legalized for recreational use
mjlegal <- data.frame(
  id      = 1:8,
  content = c("Colorado", "Washington","Oregon", "Alaska", 
              "Nevada", "California", "Maine", "Massachusettes"),
   start   = c("2012-11-06", "2012-11-06","2014-11-04", "2014-11-04",
              "2016-11-08", "2016-11-08", "2016-11-08", "2016-11-08"),
  end     = c(NA, NA, NA, NA, NA, NA, NA, NA)
)

timevis(mjlegal)
```

### Investigation and Selected Plots

We initially began by investigating the amount of marijuana use for 12-17 year olds in Colorado during the years surrounding its legalization in 2012 and comparing it to other substance use around the same times. Notably, marijuana use itself has been rapidly increasing on average over the past ten or so years.
<br>

```{r Colorado Time Series, echo = FALSE, message = FALSE}
library(tidyverse)
library(haven)
library(ggplot2)
library(plotly)

saes = read_sas("./state_saes_final.sas7bdat") %>%
  janitor::clean_names() %>% 
  filter(pyear > 4 & pyear != 12 & area == 2) %>% 
  select(outname, pyearnm, area, stname, pyear, agegrp, est_total, nsel, ncomp, pop) %>% 
  mutate(agegrp = ifelse(agegrp == 0, "All",
                         ifelse(agegrp == 1, "12 to 17",
                         ifelse(agegrp == 2, "18 to 25",
                         ifelse(agegrp == 4, "26 or older", NA))))) %>% 
  filter(!is.na(agegrp),
         outname %in% c("alcohol use in the past month", 
                        "binge alcohol use in the past month",
                      "illicit drug use other than marijuana in the past month",
                      "cigarette use in the past month",
                      "tobacco use in the past month",
                      "marijuana use in the past month"
                      )) 
saes$pyearnm = as.factor(saes$pyearnm)
levels(saes$pyearnm)[c(7)] <- c('2010-2011')


#Time-series graph: MJ use in Colorado among 12-17 yr olds
saes %>% 
    filter(outname == "marijuana use in the past month",
           agegrp == "12 to 17",
           stname == "Colorado") %>% 
    plot_ly(x = ~pyearnm, y = ~est_total, type = "scatter", mode = "lines+markers", hoverinfo = 'text', text = ~paste("Year:", pyearnm, '<br>', "Total count:", est_total),
          marker = list(size = 10,
                       color = 'rgba(255, 182, 193, .9)',
                       line = list(color = 'rgba(152, 0, 0, .8)',
                                   width = 2))) %>%
  layout(title = "Marijuana use in the past month among 12 - 17 year olds, Colorado",
         yaxis = list(zeroline = TRUE, title = "Estimated Total Number of Users (in thousands)"),
         xaxis = list(zeroline = TRUE, title = "Year Range"),
         margin = list(b = 100), xaxis = list(tickprefix = " "))
```

<br>
Unfortunately, it appeared that alcohol and illicit substance use was relatively unaffected in the years immediately following legalization. Legalization did not seem to affect the amount of people involving themselves with alcohol or illicit substances. Only cigarette use, visualized in the graph below, seemed to follow a downward trend that mirrored Marijuana's upward trend. While it would be fantastic to be able to suggest the two are related, most other states share a similar trend of decreasing cigarette use.
<br>

``` {r plots, echo = FALSE, message = FALSE}
#Time-Series graph: tobacco use in Colorado among 12-17 yr olds
saes %>% 
    filter(outname == "tobacco use in the past month",
           agegrp == "12 to 17",
           stname == "Colorado") %>% 
    plot_ly(x = ~pyearnm, y = ~est_total, type = "scatter", mode = "lines+markers", hoverinfo = 'text', text = ~paste("Year:", pyearnm, '<br>', "Total count:", est_total),
          marker = list(size = 10,
                       color = 'rgba(255, 182, 193, .9)',
                       line = list(color = 'rgba(152, 0, 0, .8)',
                                   width = 2))) %>%
  layout(title = "Tobacco use in the past month among 12 - 17 year olds, Colorado",
         yaxis = list(zeroline = TRUE, title = "Estimated Total Number of Users (in thousands)"),
         xaxis = list(zeroline = TRUE, title = "Year Range"),
         margin = list(b = 100), xaxis = list(tickprefix = " "))
```

<br>
We then decided to compare trends of Marijuana use in Colorado compared to other states to examine if it had a higher rate of adoption following legalization. In the example shown below, we examined marijuana use for 12-17 year olds in Colorado compared to those in Alabama. From the comparison, it does appear that marijuana use in Colorado is increasing at a much faster rate in Colorado. It is difficult to say if this is attributable to legalization, given that it was increasing similarly before legalization.
<br>

```{r Comparison,  echo = FALSE, message = FALSE}
# Comparison graph: Colorado vs. Alabama, MJ use in past month, 18-25 yr olds

# Fix for ggplotly's poor graph axis scaling
levels(saes$pyearnm) = gsub("-", "\n \n", levels(saes$pyearnm))

# Generating ggplot
  p = saes %>%
    filter(stname %in% c("Colorado", "Alabama"), 
           agegrp == "18 to 25", 
           outname == "marijuana use in the past month") %>%
    ggplot(aes(x = pyearnm, y = est_total*1000/pop*100, fill = stname, text = paste('State:', stname, '</br></br>Year:', substring(pyearnm,1,4), '</br>Proportion Users:', round(est_total*1000/pop*100,2), "%"))) +
    geom_bar(colour = "black", position = position_dodge(width = 0.6), stat = "identity") + labs(
      title = "Comparing Monthly Substance Users Between States, ages 18 to 25",
      x = "Years",
      y = "Proportion Users to Population (%)",
      fill = "States Compared:"
    ) + 
    theme_bw() +
    theme(axis.text.x = element_text(vjust = 0.5), axis.title.x = element_blank(), legend.title = element_blank()) + 
        scale_y_continuous(limits = c(0, 100) ,breaks = seq(0, 100, 5));
  
  # Generating plotly graph. Attempt to make hovertext informative. Plotly does not handle hovertext well when creating the graph from ggplot
  ggplotly(p, tooltip = c('text'))

# I want to get off ggplotly's wild ride
levels(saes$pyearnm) = gsub("\n \n", "-", levels(saes$pyearnm))
```

<br>
Finally, to generate a broad visual of marijuana users compared to the general population, we generated a scatter plot plotting the two for selected years and age groups. In our selected example, we look at marijuana use for 12-17 year olds in 2014-2015 for all 50 states. There are several interesting points to consider when looking at this plot:

* It does not appear that total population correlates perfectly with users, as Texas has a greater population than New York with less marijuana users
* Most of the states that would vote to legalize marijuana in the future (Massachusets, Oregon, California) are over what appears to be the trendline for states
<br>

```{r Scatterplot, echo = FALSE, message = FALSE}
#Scatter graph: tobacco use in Colorado among 12-17 yr olds  
saes %>%
  filter(agegrp == "All", 
         outname == "marijuana use in the past month", 
         pyearnm == "2014-2015") %>%
  plot_ly(
  x = ~pop, y = ~est_total*1000,
  # Hover text:
  hoverinfo = 'text',
  text = ~paste("State:", stname, '<br>Total Users:', est_total*1000, '<br>Population:', pop),
  color = ~est_total, size = ~est_total) %>%
  layout(title = "Scatterplot Comparing MJ Users Against Total Population, 2014-2015",
         yaxis = list(title = "Estimated User Total"),
         xaxis = list(title = "Population Total "),
         margin = list(b = 100), xaxis = list(tickprefix = " "))
```
