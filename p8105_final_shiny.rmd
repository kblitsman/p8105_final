---
title: "Final Project" 
output: 
  flexdashboard::flex_dashboard:
    orientation: row
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(readr)
library(stringr)
library(ggplot2)
library(haven)
library(janitor)
library(shiny)
library(viridis)

saes = read_sas("./state_saes_final.sas7bdat") %>%
  clean_names() %>% 
  filter(pyear > 4 & pyear != 12 & area == 2) %>% 
  select(outname, pyearnm, area, stname, pyear, agegrp, est_total, nsel, ncomp, pop) %>% 
  mutate(agegrp = ifelse(agegrp == 0, "12 or older",
                         ifelse(agegrp == 1, "12 to 17",
                         ifelse(agegrp == 2, "18 to 25",
                         ifelse(agegrp == 3, "18 or older",
                         ifelse(agegrp == 4, "26 or older",
                         ifelse(agegrp == 5, "12 to 20", NA)))))))
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r widgets, echo=FALSE}
# selectInput widget: State
states = saes %>% distinct(stname) %>% pull()
selectInput("state_choice", label = h3("Select state"),
            choices = states, selected = "Colorado")
renderPrint({ 
  input$state_choice
})

# selectInput widget: outcome
outcomes = saes %>% distinct(outname) %>% pull()
selectInput("outcome_choice", label = h3("Select outcome"),
            choices = outcomes, selected = "marijuana use in the past year")
renderPrint({ 
  input$outcome_choice
})

# radioButtons widget: age group
age_group = saes %>% distinct(agegrp) %>% pull()
radioButtons("age_group", label = h3("Choose age group"),
    choices = age_group, 
    selected = "18 or older")
renderPrint({ 
  input$age_group
})


```


Row
-----------------------------------------------------------------------

### Time-series graph

```{r}
saes$hover <- with(saes, paste(pyearnm, '<br>', "Total count (Thousands):", est_total))

renderPlotly({
  saes %>% 
    filter(outname == input$outcome_choice,
           agegrp == input$age_group,
           stname == input$state_choice) %>% 
    plot_ly(x = ~pyearnm, y = ~est_total, type = "scatter", mode = "markers", hoverinfo = 'text', text = ~paste(pyearnm, '<br>', "Total count:", est_total),
          marker = list(size = 10,
                       color = 'rgba(255, 182, 193, .9)',
                       line = list(color = 'rgba(152, 0, 0, .8)',
                                   width = 2))) %>%
  layout(title = input$outcomechoice,
         yaxis = list(zeroline = TRUE, title = "Count"),
         xaxis = list(zeroline =TRUE, title = "Year Range"))
})
```

